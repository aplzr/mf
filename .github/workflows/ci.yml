name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read
  checks: write

jobs:
  tests:
    name: Tests (py${{ matrix.python }} - linux)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python: ["3.10", "3.11", "3.12", "3.13"]
    env:
      # Generate & upload coverage only for latest stable Python (3.13) to reduce minutes
      COVERAGE: ${{ matrix.python == '3.13' }}
      PYTHONDONTWRITEBYTECODE: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install uv
        run: pip install uv

      - name: Cache uv build artifacts
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ matrix.python }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            uv-${{ runner.os }}-

      - name: Install project (with dev extras) using uv
        run: uv pip install --system .[dev]

      - name: Show environment
        run: |
          python -V
          uv pip list

      - name: Run tests (with coverage if selected)
        run: |
          if [ "$COVERAGE" = "true" ]; then
            echo "Running tests WITH coverage"
            pytest
          else
            echo "Running tests WITHOUT coverage"
            pytest -q --no-cov
          fi

      - name: Upload coverage artifacts
        if: env.COVERAGE == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: |
            coverage.xml
            htmlcov/
          if-no-files-found: error
      - name: Generate coverage badge (genbadge)
        if: env.COVERAGE == 'true'
        run: |
          uv pip install --system genbadge[coverage]
          mkdir -p static
          genbadge coverage -i coverage.xml -o static/badge_coverage.svg
      - name: Upload coverage badge artifact
        if: env.COVERAGE == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-badge
          path: static/badge_coverage.svg
          if-no-files-found: error
      - name: Commit updated badge if coverage changed
        if: env.COVERAGE == 'true' && github.ref == 'refs/heads/main'
        run: |
          set -euo pipefail
          # Extract current coverage percent
          PCT=$(python -c "import re,pathlib; xml=pathlib.Path('coverage.xml').read_text(); m=re.search(r'line-rate=\"([0-9.]+)\"', xml); print(round(float(m.group(1))*100) if m else -1)")
          # Read previous percent if exists
          if [ -f static/coverage.json ]; then
            PREV=$(python -c "import json,pathlib; p=pathlib.Path('static/coverage.json'); print(json.loads(p.read_text()).get('coverage',-1))")
          else
            PREV=-1
          fi
          echo "Previous: $PREV%, Current: $PCT%"
          if [ "$PCT" = "-1" ] || [ "$PCT" = "$PREV" ]; then
            echo "Coverage unchanged; skipping commit."
            exit 0
          fi
          echo "{\"coverage\": $PCT}" > static/coverage.json
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add static/badge_coverage.svg static/coverage.json
          git diff --cached --quiet && echo "Nothing to commit" && exit 0
          git commit -m "chore: update coverage badge ($PCT%)"
          git push

  lint:
    name: Ruff lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      - name: Install uv
        run: pip install uv
      - name: Install ruff
        run: uv pip install --system ruff
      - name: Run ruff checks
        run: ruff check .
